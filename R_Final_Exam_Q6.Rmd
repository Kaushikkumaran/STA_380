---
title: "R Exam Part 2"
author: "Kaushik Kumaran"
date: "8/12/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Main Idea:
Find associations between items by looking for combinations of products that frequently co-occur in transactions. In other words, it allows the supermarkets to identify relationships between the products that people buy.

## Key Definitions:

Support : % of transactions that contain all items in an item set. High value of support is preferred since they are likely to be applicable to a large number of future transactions.

Confidence : the probability that a transaction that contains the items on the left hand side of the rule also contains the item on the right hand side.

Lift : Probability of all items occur together / product of the probabilities of the items on the left and right hand side occurring as if there was no association between them

## Algorithm:

Data mining algorithm used - Apriori Algorithm which works in two steps:
- Systematically identify itemsets that occur frequently in the data set with a support greater than a pre-specified threshold.
- Calculate the confidence of all possible rules given the frequent itemsets and keep only those with a confidence greater than a pre-specified threshold.

### Importing the required Libraries
tidyverse - Data wrangling
arules - To use the Apriori algorithm
arulesViz - Visualize the Apriori rules
reshape - used to melt the dataframe for summary
ggplot - For plotting
```{r Import Libraries, echo = FALSE}
library(tidyverse)
library(arules)
library(arulesViz)
library(reshape2)
library(ggplot2)
```

### Step 1 : Read the data, understand the summary and pre processing
- Read the file using read csv function and header = FALSE parameter
- Rename columns as Item1, Item2, Item3 and Item4

- Melt the data frame to get the summary by plots 
- Group by the items and plot the top 10 items after removing blank
- Used ggplot to create the plots

```{r Reading and Transformation, echo = FALSE}
groceries <- read.csv("~/Documents/Kaushik Kumaran/Documents/UT Docs/Intro to Machine Learning/STA380-master/data/groceries.txt", header=FALSE)

groceries <- groceries %>% 
  rename(
    Item1 = V1,
    Item2 = V2,
    Item3 = V3,
    Item4 = V4
    )

total_groceries <- melt(groceries, id=c())

total_groceries1 <- total_groceries %>%
   filter(value != '') %>%
   group_by(value) %>%
    summarise(count_items=n()) %>%
  arrange(desc(count_items)) %>%
  slice(1:10)

total_groceries1$value <- factor(total_groceries1$value, levels = total_groceries1$value[order(total_groceries1$count_items,decreasing = TRUE)])    
total_groceries1 %>%
  ggplot(., aes(x=value, y=count_items))+
              geom_col()
```
On plotting the top 20 items, we see that whole milk is purchased most frequently.
Other items which are frequently purchased in the itemset include Other vegetables, rolls/buns, soda, yogurt.

### Step 2: Convert to required format for Apriori algorithm 
- Use and convert to the transactions format
- Check for duplicates across columns
```{r Formatting for Apriori algorithms, echo = FALSE}
groceries_trans <- read.transactions('~/Documents/Kaushik Kumaran/Documents/UT Docs/Intro to Machine Learning/STA380-master/data/groceries.txt', sep=',')
```

### Step 3: Build and Inspect the algorithm
- Apriori algorithm 1 - Min support of 0.005, min confidence of 0.1 and max length of 5
```{r Build Apriori Algorithm, echo = FALSE}
grocery_rule1 = apriori(groceries_trans, 
	parameter=list(support=.005, confidence=.1, maxlen=5))
head(inspect(grocery_rule1))
```
Inspection : There are almost 1582 associations with Min support of 0.005, min confidence of 0.1 

### Step 4 : Plotting the entire network
```{r Plot Network, echo = FALSE}
plot(grocery_rule1)
plot(grocery_rule1, measure = c("support", "lift"), shading = "confidence")
```
We see the plot of support against lift with confidence being the color scale. We also see support against confidence with lift as colour scale.

We will next look into subsets of data to derive more insights.

### Step 5 : Inspection of certain subsets
- Inspect subset with lift > 4, support > 0.005 and confidence > 0.1
```{r Inspect subsets, echo = FALSE}
sub1 = subset(grocery_rule1, subset=lift > 4 & support > 0.005 & confidence > 0.1)
inspect(sub1)
plot(sub1, method='graph')
```
We observe that white bread is frequently sold along with ham and gives a lift of 4.6 (also satisfies the support and confidence conditions)
Whenever a customer has butter along with other vegetables, he would most probably purchase whipped/sour cream as well
Although we have seen these observations, we see that the support here is quite low which means that they tend to happen very rarely.

As a next step, we will try and increase the support values while reducing the lift values

- Inspect subset with lift > 2, support > 0.002 and confidence > 0.2
```{r Inspect subset2, echo = FALSE}
sub1 = subset(grocery_rule1, subset=lift > 2 & support > 0.02 & confidence > 0.2)
inspect(sub1)
plot(sub1, method='graph')
```
We observe that yogurt is sold along with whipped/sour cream, yogurt gets a lift of ~2 and they have a good support as well.
The above conditions are satisfied by the following few conditions as well:
- Other vegetables are bought when whipped/sour cream is bought
- Tropical fruit is bought when pip fruit is bought
- yogurt and tropical fruit are bought in conjunction

We can also look at more subsets of data to draw further insights:

a) Napkin Association rule:
```{r Napkins subset, echo = FALSE}
napkins_rules <- subset(grocery_rule1, items %in% 'napkins')
inspect(sort(napkins_rules, by = 'lift')[1:10])
plot(head(napkins_rules, 5, by='lift'), method='graph')
```
We see that napkins are highly associated with hygiene articles due to which the lift is very high.

```{r Cream association, echo = FALSE}
cream_rules <- subset(grocery_rule1, items %in% 'whipped/sour cream')
inspect(sort(cream_rules, by = 'lift')[1:10])
plot(head(cream_rules, 5, by='lift'), method='graph')
```
Berries, whipped cream and butter are bought together. These are the people who are interested in baking.

```{r Ham association, echo=FALSE}
ham_rules <- subset(grocery_rule1, items %in% 'ham')
inspect(sort(ham_rules, by = 'lift')[1:3])
plot(head(ham_rules, 5, by='lift'), method='graph')
```
Ham is bought together with white bread and other vegetables. 

## INSIGHTS SUMMARY: 
- Bread is frequently sold with Ham with very high lift but the support is a little low
- Yogurt is sold along with whipped/sour cream, yogurt gets a lift of ~2 and they have a good support as well
- We see that napkins are highly associated with hygiene articles due to which the lift is very high
- Ham is bought together with white bread and other vegetables
- Tropical fruit is bought when pip fruit is bought
- yogurt and tropical fruit are bought in conjunction