---
title: "R_Final_Exam_Q3"
author: "Kaushik Kumaran"
date: "8/15/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Portfolio Modeling

### Step 1 : Loading the required libraries
Mosaic Library - used to make many common tasks fit into a common template
Quantmod - Used to get the stock values for the financial portfolios
foreach - Used to run the foreach loop for bootstrapping
```{r Loading Libraries, echo = FALSE}
library(mosaic)
library(quantmod)
library(foreach)
```

### Step 2 : Selecting of ETFs
The goal is to select a diverse set of ETFs which include:
Safe:
SPY - One of the largest and safest ETFs, tops the list in terms of AUM and trading volume
IVV - iShares Core S&P 500 ETF tracks the S&P 500 (top holdings include Apple, Microsoft, Amazon, Facebook)
Risky:
SVXY - Short VIX Short Term, there was a decline for this ETF couple of years back. This is an unusual ETF since the performance is dependent on the market volatility, not security.
Aggressive:
IHI (iShares US Medical Devices) -  high risk and high return potential
IGV(iShares Expanded Tech-Software) - ETF with high risk and high return potential

Get symbols function uses the quantmod library and gets the values of the prices from the specified date

```{r ETF list, echo = FALSE}
etf_list = c("SPY", "IVV", "SVXY", "IHI", "IGV")
prices_etf_list = getSymbols(etf_list, from = "2016-01-01")
```

### Step 3 : Preprocessing and trend monitoring
-adjusting the splits and the dividends
- combine close to close changes in a single matrix
- Plot close to close changes
- Look at market returns over time
```{r Preprocessing, echo=FALSE}
for(ticker in etf_list) {
	expr = paste0(ticker, "a = adjustOHLC(", ticker, ")")
	eval(parse(text=expr))
}

all_returns = cbind(	
                ClCl(SPYa),
								ClCl(IVVa),
								ClCl(SVXYa),
								ClCl(IHIa),
								ClCl(IGVa))
all_returns = as.matrix(na.omit(all_returns))

plot(ClCl(SPYa))
plot(ClCl(IVVa))
plot(ClCl(SVXYa))
plot(ClCl(IHIa))
plot(ClCl(IGVa))

par(mfrow = c(1,1))
plot(all_returns[,3], type='l')

acf(all_returns[,3])
```

Interpretation:
- ACF plots shows that there is no significant correlation beyween returns of today and any other day in past 30 days period
- Most of the  plots are quite volatile, thereby we need a more robust method in order to predict  the returns. Hence, we would be using bootstrapping technique for the same.

## Building model with equal weights to all stock types
Procedure:
- Initialize the wealth to $ 100,000
- Initially the total wealth is equal to the initial wealth
- Let's consider that we are taking the number of days ahead as 30
- Let's simulate the values for 5000 times
- Once we get the returns value for today, we calculate the total wealth using the formula (holdings + holdings*return_today)
- Rebalancing the weight is an optional step
```{r Building the model, echo = FALSE}
set.seed(20)
initial_wealth = 100000
sim1 = foreach(i=1:5000, .combine='rbind') %do% {
	total_wealth = initial_wealth
	weights = c(0.2, 0.2, 0.2, 0.2, 0.2)
	holdings = weights * total_wealth
	n_days = 30
	wealthtracker_diverse = rep(0, n_days)
	for(today in 1:n_days) {
		return_today = resample(all_returns, 1, orig.ids=FALSE)
		holdings = holdings + holdings*return_today
		total_wealth = sum(holdings)
		wealthtracker_diverse[today] = total_wealth
		holdings = weights * total_wealth
	}
	wealthtracker_diverse
}

hist(sim1[,n_days], 30,
     main="Equal weights Holdings Distribution",
     xlab="Portfolio Value")
wealthtracker_diverse

quantile(sim1[,20] - 100000, 0.05)
quantile(sim1[,20] - 100000, 0.25)
quantile(sim1[,20] - 100000, 0.5)
quantile(sim1[,20] - 100000, 0.75)
quantile(sim1[,20] - 100000, 0.95)
```
- The value of risk at 5% level is $11426 (~11.4% of the initial capital)
- The value of risk at 25% level is $2706 (~2.7% of the initial capital)
- At median level profit is $1990 (~1.9% of the initial capital)
- At 75% level profit is $6483 (~6.4% of the initial capital)
- At 95% level profit is $14651 (~14.6% of the initial capital)

## Building model with more weights to safe stocks
- Similar procedure as before just that we change the weights for each stock

```{r Building the model2, echo = FALSE}
set.seed(20)
initial_wealth = 100000
sim2 = foreach(i=1:5000, .combine='rbind') %do% {
	total_wealth = initial_wealth
	weights = c(0.35, 0.35, 0.1, 0.1, 0.1)
	holdings = weights * total_wealth
	n_days = 30
	wealthtracker_diverse = rep(0, n_days)
	for(today in 1:n_days) {
		return_today = resample(all_returns, 1, orig.ids=FALSE)
		holdings = holdings + holdings*return_today
		total_wealth = sum(holdings)
		wealthtracker_diverse[today] = total_wealth
		holdings = weights * total_wealth
	}
	wealthtracker_diverse
}

hist(sim2[,n_days], 30,
     main="Equal weights Holdings Distribution",
     xlab="Portfolio Value")
wealthtracker_diverse

quantile(sim2[,20] - 100000, 0.05)
quantile(sim2[,20] - 100000, 0.25)
quantile(sim2[,20] - 100000, 0.5)
quantile(sim2[,20] - 100000, 0.75)
quantile(sim2[,20] - 100000, 0.95)
```
- The value of risk at 5% level is $8684 (~8.6% of the initial capital)
- The value of risk at 25% level is $2235 (~2.2% of the initial capital)
- At median level profit is $1717 (~1.7% of the initial capital)
- At 75% level profit is $5571 (~5.5% of the initial capital)
- At 95% level profit is $12503 (~12.5% of the initial capital)

## Building model with more weights to aggressive stocks
- Similar procedure as before just that we change the weights for each stock
We expect that these results would be more volatile

```{r Building the model3, echo = FALSE}
set.seed(20)
initial_wealth = 100000
sim3 = foreach(i=1:5000, .combine='rbind') %do% {
	total_wealth = initial_wealth
	weights = c(0.1, 0.1, 0.2, 0.3, 0.3)
	holdings = weights * total_wealth
	n_days = 30
	wealthtracker_diverse = rep(0, n_days)
	for(today in 1:n_days) {
		return_today = resample(all_returns, 1, orig.ids=FALSE)
		holdings = holdings + holdings*return_today
		total_wealth = sum(holdings)
		wealthtracker_diverse[today] = total_wealth
		holdings = weights * total_wealth
	}
	wealthtracker_diverse
}

hist(sim3[,n_days], 30,
     main="Equal weights Holdings Distribution",
     xlab="Portfolio Value")
wealthtracker_diverse

quantile(sim3[,20] - 100000, 0.05)
quantile(sim3[,20] - 100000, 0.25)
quantile(sim3[,20] - 100000, 0.5)
quantile(sim3[,20] - 100000, 0.75)
quantile(sim3[,20] - 100000, 0.95)
```
- The value of risk at 5% level is $11546 (~11.5% of the initial capital)
- The value of risk at 25% level is $2691 (~2.6% of the initial capital)
- At median level profit is $2056 (~2% of the initial capital)
- At 75% level profit is $6684 (~6.6% of the initial capital)
- At 95% level profit is $15046 (~15% of the initial capital)

## Conclusion:
Equal weights for all stock types - We see that the numbers here are moderate to high volatile and the worst case would be a loss of 11.4% and best case is 14.6% profit. Median is 1.9% profit

More weights for all safe stock types - We see that the numbers here are not too volatile and the worst case would be a loss of 8.6% and best case is 12.5% profit. Median is 1.7% profit

More weights for all aggressive stock types - We see that the numbers here are not too volatile and the worst case would be a loss of 11.5% and best case is 15% profit. Median is 2% profit